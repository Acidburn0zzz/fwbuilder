## -*- mode: shell-script; -*- 
##
{{$top_comment}}

{{$shell_debug}}

{{$path}}

{{$constants}}

{{$tools}}

{{$shell_functions}}

## we do not load modules on Sveasoft
load_modules() {
}

verify_interfaces() {
    {{$verify_interfaces}}
}

prolog_commands() {
    echo "Running prolog script"
    {{$prolog_script}}
}

epilog_commands() {
    echo "Running epilog script"
    {{$epilog_script}}
}

run_epilog_and_exit() {
    epilog_commands
    exit $1
}

configure_interfaces() {
    {{$configure_interfaces}}
}

script_body() {
    {{$script_body}}
}

ip_forward() {
    {{$ip_forward_commands}}
}

reset_all() {
    {{$reset_all}}
}

# For backwards compatibility missing argument is equivalent to 'start'
test -z "$1" && {
    $0 start
    exit $?
}

case "$1" in
    start)
        log "Activating firewall script generated {{$timestamp}} by {{$user}}"
        check_tools
        {{if prolog_top}}prolog_commands{{endif}}
        load_modules
        configure_interfaces
        verify_interfaces
        {{if prolog_after_interfaces}}prolog_commands{{endif}}
        {{if not_using_iptables_restore}} reset_all {{endif}}
        {{if prolog_after_flush}}prolog_commands{{endif}}
        script_body
        ip_forward
        epilog_commands
        ;;

    stop)
        reset_all
        ;;
    
    reload)
        $0 stop
        $0 start
        ;;
    
    interfaces)
        configure_interfaces
        ;;
    
    test_interfaces)
        FWBDEBUG="echo"
        configure_interfaces
        ;;
    
    *)
        echo "Usage $0 {start|stop|reload|interfaces|test_interfaces}"
        ;;
    
esac

